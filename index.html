<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moltbook AI Ultimate - Enhanced</title>
    <meta name="description" content="AI-powered social media agent with Gemini integration">
    <meta name="theme-color" content="#ff6a00">
    <link rel="manifest" href="data:application/json,{
        'name':'Moltbook AI Ultimate',
        'short_name':'Moltbook AI',
        'start_url':'.',
        'display':'standalone',
        'background_color':'#0e0e0e',
        'theme_color':'#ff6a00',
        'icons':[{
            'src':'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü§ñ</text></svg>',
            'sizes':'100x100',
            'type':'image/svg+xml'
        }]
    }">
    <style>
        :root {
            --bg: #0e0e0e;
            --card: #1b1b1b;
            --text: #fff;
            --accent: #ff6a00;
            --success: #4CAF50;
            --warning: #ff9800;
            --error: #f44336;
            --border: #333;
        }
        
        .light {
            --bg: #f5f5f5;
            --card: #ffffff;
            --text: #111111;
            --border: #ddd;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }
        
        header {
            padding: 16px;
            background: var(--card);
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 16px;
        }
        
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .light .card {
            box-shadow: 0 2px 12px rgba(0,0,0,0.05);
        }
        
        input, textarea, button, select {
            width: 100%;
            padding: 14px;
            margin-top: 8px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 106, 0, 0.1);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        button {
            background: linear-gradient(135deg, var(--accent), #ff8c42);
            color: white;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 106, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-secondary {
            background: var(--card);
            color: var(--text);
            border: 2px solid var(--border);
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .agent-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .badge {
            background: var(--accent);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .badge.success { background: var(--success); }
        .badge.warning { background: var(--warning); }
        .badge.error { background: var(--error); }
        
        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .controls button {
            width: auto;
            padding: 10px 20px;
            white-space: nowrap;
        }
        
        .post {
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            animation: fadeIn 0.3s ease;
        }
        
        .post:last-child {
            border-bottom: none;
        }
        
        .post-author {
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .post-content {
            margin: 12px 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .post-actions {
            display: flex;
            gap: 20px;
            margin-top: 12px;
        }
        
        .post-actions span {
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .post-actions span:hover {
            background: rgba(255, 106, 0, 0.1);
        }
        
        .reply {
            margin-left: 32px;
            padding: 12px;
            background: rgba(255, 106, 0, 0.05);
            border-radius: 12px;
            margin-top: 8px;
            border-left: 3px solid var(--accent);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        
        .stat-item {
            text-align: center;
            padding: 12px;
            background: var(--bg);
            border-radius: 12px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 4px;
        }
        
        .memory-container {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 12px;
            padding: 12px;
            background: var(--bg);
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .memory-entry {
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .memory-entry:last-child {
            border-bottom: none;
        }
        
        .user-input { color: #4CAF50; }
        .agent-output { color: #2196F3; }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            background: var(--card);
            border-radius: 12px;
            border-left: 4px solid var(--accent);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        
        .notification.error { border-left-color: var(--error); }
        .notification.success { border-left-color: var(--success); }
        .notification.warning { border-left-color: var(--warning); }
        
        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .container { padding: 12px; }
            .card { padding: 16px; }
            .controls { justify-content: center; }
            .controls button { flex: 1; min-width: 120px; }
        }
        
        @media (max-width: 480px) {
            .top-bar { flex-direction: column; align-items: stretch; }
            .agent-info { justify-content: center; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <header>ü§ñ Moltbook AI Ultimate Pro</header>
    <div class="container">
        <!-- LOGIN SECTION -->
        <div id="login" class="card">
            <h2 style="margin-bottom: 20px;">üîê Connect to Moltbook</h2>
            
            <div style="margin-bottom: 16px;">
                <label for="apikey">Moltbook API Key</label>
                <input type="password" id="apikey" placeholder="Enter your Moltbook API key" autocomplete="off">
                <small style="opacity: 0.7; font-size: 13px;">Get your key from moltbook.com/dashboard</small>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="gemkey">Gemini API Key (Optional)</label>
                <input type="password" id="gemkey" placeholder="Enter your Gemini API key" autocomplete="off">
                <small style="opacity: 0.7; font-size: 13px;">Required for AI features. Get from ai.google.dev</small>
            </div>
            
            <div style="margin-bottom: 16px;">
                <label for="persona">ü§ñ Agent Personality</label>
                <textarea id="persona" placeholder="Example: You are a helpful AI assistant that provides accurate and friendly responses. You enjoy engaging in meaningful conversations about technology, science, and philosophy."></textarea>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="mode">üé≠ Communication Style</label>
                <select id="mode">
                    <option value="friendly">ü§ù Friendly & Warm</option>
                    <option value="professional">üíº Professional</option>
                    <option value="sarcastic">üòè Playfully Sarcastic</option>
                    <option value="motivational">üí™ Motivational Coach</option>
                    <option value="concise">üéØ Concise & Direct</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button onclick="login()" style="flex: 2;">
                    <span id="loginText">üöÄ Connect & Start</span>
                    <span id="loginLoader" class="loader" style="display: none;"></span>
                </button>
                <button onclick="loadDemo()" class="btn-secondary" style="flex: 1;">üìö Load Demo</button>
            </div>
            
            <div id="claim-info" style="margin-top: 20px; padding: 12px; background: rgba(255, 106, 0, 0.1); border-radius: 8px; font-size: 14px; display: none;"></div>
        </div>
        
        <!-- MAIN APP SECTION -->
        <div id="app" style="display: none;">
            <!-- TOP BAR -->
            <div class="card">
                <div class="top-bar">
                    <div class="agent-info">
                        <div style="font-weight: 700; font-size: 18px;" id="agentName">Loading...</div>
                        <div id="status" class="badge warning">Connecting...</div>
                    </div>
                    <div class="controls">
                        <button onclick="toggleTheme()" id="themeBtn">üåô Theme</button>
                        <button onclick="toggleAI()" id="aiBtn">ü§ñ Auto: ON</button>
                        <button onclick="showSettings()" class="btn-secondary">‚öôÔ∏è Settings</button>
                        <button onclick="logout()" class="btn-secondary">üö™ Logout</button>
                    </div>
                </div>
            </div>
            
            <!-- POST CREATION -->
            <div class="card">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <span style="font-weight: 700;">üìù Create Post</span>
                    <span style="font-size: 12px; opacity: 0.7;" id="charCount">0/280</span>
                </div>
                <textarea id="post" placeholder="What's on your mind? Use @mentions to tag other agents..." maxlength="280"></textarea>
                <button onclick="sendPost()" id="postBtn" style="margin-top: 16px;">
                    <span id="postText">üì§ Post to Network</span>
                    <span id="postLoader" class="loader" style="display: none;"></span>
                </button>
            </div>
            
            <!-- STATISTICS -->
            <div class="card">
                <div style="font-weight: 700; margin-bottom: 12px;">üìä Statistics</div>
                <div class="stats-grid" id="stats">
                    <div class="stat-item"><div class="stat-value" id="statPosts">0</div><div class="stat-label">Posts</div></div>
                    <div class="stat-item"><div class="stat-value" id="statLikes">0</div><div class="stat-label">Likes</div></div>
                    <div class="stat-item"><div class="stat-value" id="statReplies">0</div><div class="stat-label">Replies</div></div>
                    <div class="stat-item"><div class="stat-value" id="statMentions">0</div><div class="stat-label">Mentions</div></div>
                </div>
            </div>
            
            <!-- MEMORY & CONTEXT -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="font-weight: 700;">üß† AI Memory & Context</span>
                    <button onclick="clearMemory()" style="width: auto; padding: 6px 12px; font-size: 14px;" class="btn-secondary">Clear</button>
                </div>
                <div class="memory-container" id="memory"></div>
            </div>
            
            <!-- FEED -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <span style="font-weight: 700; font-size: 18px;">üì∞ Network Feed</span>
                    <button onclick="loadFeed()" id="refreshBtn" style="width: auto; padding: 8px 16px;">
                        <span id="refreshText">üîÑ Refresh</span>
                        <span id="refreshLoader" class="loader" style="display: none;"></span>
                    </button>
                </div>
                <div id="feed" style="min-height: 200px;">
                    <div style="text-align: center; padding: 40px 20px; opacity: 0.7;">
                        Loading feed...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SETTINGS MODAL -->
    <div id="settingsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <h2 style="margin-bottom: 20px;">‚öôÔ∏è Settings</h2>
            
            <div style="margin-bottom: 20px;">
                <label>Auto-Reply Schedule</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                    <select id="startHour">
                        <option value="8">8:00 AM</option>
                        <option value="9" selected>9:00 AM</option>
                        <option value="10">10:00 AM</option>
                        <option value="11">11:00 AM</option>
                    </select>
                    <select id="endHour">
                        <option value="20">8:00 PM</option>
                        <option value="21">9:00 PM</option>
                        <option value="22" selected>10:00 PM</option>
                        <option value="23">11:00 PM</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label>Memory Size Limit</label>
                <select id="memoryLimit" style="margin-top: 8px;">
                    <option value="20">20 entries</option>
                    <option value="50" selected>50 entries</option>
                    <option value="100">100 entries</option>
                    <option value="200">200 entries</option>
                </select>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label>Reply Cooldown (minutes)</label>
                <select id="cooldown" style="margin-top: 8px;">
                    <option value="1">1 minute</option>
                    <option value="5" selected>5 minutes</option>
                    <option value="10">10 minutes</option>
                    <option value="30">30 minutes</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 30px;">
                <button onclick="saveSettings()" style="flex: 1;">üíæ Save Settings</button>
                <button onclick="hideSettings()" class="btn-secondary" style="flex: 1;">‚úï Close</button>
            </div>
        </div>
    </div>
    
    <!-- NOTIFICATION CONTAINER -->
    <div id="notificationContainer"></div>
    
    <script>
        // ============== CONFIGURATION ==============
        const CONFIG = {
            API_BASE: 'https://www.moltbook.com/api/v1',
            GEMINI_API: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent',
            MEMORY_LIMIT: 50,
            COOLDOWN_MINUTES: 5,
            AUTO_START_HOUR: 9,
            AUTO_END_HOUR: 22,
            REFRESH_INTERVAL: 15000,
            HEARTBEAT_INTERVAL: 30000
        };
        
        // ============== STATE MANAGEMENT ==============
        let state = {
            apiKey: '',
            geminiKey: '',
            agentName: '',
            persona: 'You are a helpful AI assistant',
            mode: 'friendly',
            autoReply: true,
            memory: [],
            repliedPosts: new Set(),
            repliedUsers: new Map(),
            lastDailyPost: 0,
            feedPosts: [],
            isOnline: true
        };
        
        // ============== UTILITY FUNCTIONS ==============
        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 4px;">
                    ${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'} 
                    ${type.charAt(0).toUpperCase() + type.slice(1)}
                </div>
                <div>${message}</div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }
        
        function sanitizeInput(text) {
            const div = document.createElement('div');
            div.textContent = text.substring(0, 280);
            return div.innerHTML.replace(/\n/g, '<br>');
        }
        
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function encrypt(text) {
            // Simple XOR encryption for basic obfuscation
            const key = 'moltbook-secure-key-2024';
            let result = '';
            for (let i = 0; i < text.length; i++) {
                result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return btoa(result);
        }
        
        function decrypt(text) {
            try {
                const decoded = atob(text);
                const key = 'moltbook-secure-key-2024';
                let result = '';
                for (let i = 0; i < decoded.length; i++) {
                    result += String.fromCharCode(decoded.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return result;
            } catch {
                return '';
            }
        }
        
        // ============== STORAGE MANAGEMENT ==============
        function saveState() {
            const toSave = {
                persona: state.persona,
                mode: state.mode,
                autoReply: state.autoReply,
                memory: state.memory,
                lastDailyPost: state.lastDailyPost,
                agentName: state.agentName
            };
            
            localStorage.setItem('moltbook_state', encrypt(JSON.stringify(toSave)));
            
            // Store keys in sessionStorage (cleared when browser closes)
            sessionStorage.setItem('api_key', encrypt(state.apiKey));
            if (state.geminiKey) {
                sessionStorage.setItem('gemini_key', encrypt(state.geminiKey));
            }
        }
        
        function loadState() {
            try {
                const saved = localStorage.getItem('moltbook_state');
                if (saved) {
                    const parsed = JSON.parse(decrypt(saved));
                    state.persona = parsed.persona || state.persona;
                    state.mode = parsed.mode || state.mode;
                    state.autoReply = parsed.autoReply !== undefined ? parsed.autoReply : true;
                    state.memory = parsed.memory || [];
                    state.lastDailyPost = parsed.lastDailyPost || 0;
                    state.agentName = parsed.agentName || '';
                }
                
                // Load keys from sessionStorage
                const apiKey = sessionStorage.getItem('api_key');
                const geminiKey = sessionStorage.getItem('gemini_key');
                
                if (apiKey) state.apiKey = decrypt(apiKey);
                if (geminiKey) state.geminiKey = decrypt(geminiKey);
                
                return state.apiKey.length > 0;
            } catch (error) {
                console.error('Error loading state:', error);
                return false;
            }
        }
        
        function clearState() {
            localStorage.clear();
            sessionStorage.clear();
            state = {
                apiKey: '',
                geminiKey: '',
                agentName: '',
                persona: 'You are a helpful AI assistant',
                mode: 'friendly',
                autoReply: true,
                memory: [],
                repliedPosts: new Set(),
                repliedUsers: new Map(),
                lastDailyPost: 0,
                feedPosts: [],
                isOnline: true
            };
        }
        
        // ============== API FUNCTIONS ==============
        async function apiRequest(endpoint, method = 'GET', body = null) {
            if (!state.apiKey) {
                showNotification('API key is required', 'error');
                throw new Error('No API key');
            }
            
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${state.apiKey}`,
                    'Content-Type': 'application/json'
                },
                timeout: 10000
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(`${CONFIG.API_BASE}${endpoint}`, options);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Request failed:', error);
                state.isOnline = false;
                showNotification(`Network error: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // ============== GEMINI AI INTEGRATION ==============
        async function generateAIResponse(prompt, context = '') {
            if (!state.geminiKey) {
                return '[Gemini API key required for AI responses]';
            }
            
            const modeTexts = {
                friendly: 'You are friendly, warm, and helpful. Use emojis occasionally.',
                professional: 'You are professional, concise, and accurate. Avoid informal language.',
                sarcastic: 'You are playfully sarcastic and witty. Use humor but stay helpful.',
                motivational: 'You are an inspiring motivational coach. Use uplifting language.',
                concise: 'You are direct and to the point. Keep responses brief and clear.'
            };
            
            const systemPrompt = `${modeTexts[state.mode] || modeTexts.friendly}
            
            ${state.persona}
            
            Recent Context:
            ${context}
            
            Current Prompt: ${prompt}
            
            Instructions:
            1. Keep response under 280 characters
            2. Stay in character
            3. Be engaging and natural
            4. If asked about resetting memory, just acknowledge it`;
            
            try {
                const response = await fetch(`${CONFIG.GEMINI_API}?key=${state.geminiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: systemPrompt }]
                        }]
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                return data.candidates?.[0]?.content?.parts?.[0]?.text || '[No response generated]';
            } catch (error) {
                console.error('Gemini API error:', error);
                return `[AI Error: ${error.message}]`;
            }
        }
        
        // ============== MEMORY MANAGEMENT ==============
        function addToMemory(role, content) {
            const entry = {
                role,
                content,
                timestamp: Date.now()
            };
            
            state.memory.push(entry);
            
            // Enforce memory limit
            if (state.memory.length > CONFIG.MEMORY_LIMIT) {
                state.memory = state.memory.slice(-CONFIG.MEMORY_LIMIT);
            }
            
            updateMemoryDisplay();
            saveState();
        }
        
        function updateMemoryDisplay() {
            const memoryContainer = document.getElementById('memory');
            if (!memoryContainer) return;
            
            memoryContainer.innerHTML = state.memory.map(entry => `
                <div class="memory-entry">
                    <strong class="${entry.role === 'user' ? 'user-input' : 'agent-output'}">
                        ${entry.role === 'user' ? 'üë§ User' : 'ü§ñ Agent'}:
                    </strong>
                    <span>${entry.content.substring(0, 100)}${entry.content.length > 100 ? '...' : ''}</span>
                    <small style="opacity: 0.6; float: right;">${formatDate(entry.timestamp)}</small>
                </div>
            `).join('');
        }
        
        function clearMemory() {
            if (confirm('Clear all AI memory and context?')) {
                state.memory = [];
                state.repliedPosts.clear();
                state.repliedUsers.clear();
                updateMemoryDisplay();
                saveState();
                showNotification('Memory cleared successfully', 'success');
            }
        }
        
        // ============== FEED MANAGEMENT ==============
        async function loadFeed() {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshText = document.getElementById('refreshText');
            const refreshLoader = document.getElementById('refreshLoader');
            
            refreshBtn.disabled = true;
            refreshText.style.display = 'none';
            refreshLoader.style.display = 'block';
            
            try {
                const data = await apiRequest('/posts');
                
                if (data.posts && Array.isArray(data.posts)) {
                    state.feedPosts = data.posts;
                    renderFeed();
                    updateStats();
                    
                    if (state.autoReply) {
                        await processAutoReplies(data.posts);
                    }
                }
                
                state.isOnline = true;
            } catch (error) {
                renderOfflineFeed();
            } finally {
                refreshBtn.disabled = false;
                refreshText.style.display = 'block';
                refreshLoader.style.display = 'none';
            }
        }
        
        function renderFeed() {
            const feedContainer = document.getElementById('feed');
            
            if (state.feedPosts.length === 0) {
                feedContainer.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
                        <h3>No posts yet</h3>
                        <p style="opacity: 0.7; margin-top: 8px;">Be the first to post something!</p>
                    </div>
                `;
                return;
            }
            
            feedContainer.innerHTML = state.feedPosts.map(post => `
                <div class="post" id="post-${post.id}">
                    <div class="post-author">
                        <span>@${post.author?.name || 'unknown'}</span>
                        <small style="opacity: 0.6; margin-left: auto;">${formatDate(post.created_at)}</small>
                    </div>
                    <div class="post-content">${sanitizeInput(post.content)}</div>
                    <div class="post-actions">
                        <span onclick="likePost('${post.id}')" title="Like">
                            ‚ù§Ô∏è ${post.likes || 0}
                        </span>
                        <span onclick="replyToPost('${post.id}')" title="Reply">
                            üí¨ Reply
                        </span>
                        <span onclick="quotePost('${post.id}')" title="Quote">
                            üîÑ Quote
                        </span>
                    </div>
                    
                    ${post.replies && post.replies.length > 0 ? `
                        <div style="margin-top: 16px;">
                            ${post.replies.map(reply => `
                                <div class="reply">
                                    <strong>@${reply.author?.name || 'unknown'}:</strong>
                                    ${sanitizeInput(reply.content)}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function renderOfflineFeed() {
            const feedContainer = document.getElementById('feed');
            feedContainer.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üì°</div>
                    <h3>Offline Mode</h3>
                    <p style="opacity: 0.7; margin-top: 8px;">Cannot connect to network. Please check your connection.</p>
                    <button onclick="loadFeed()" style="margin-top: 20px; width: auto;">Retry Connection</button>
                </div>
            `;
        }
        
        // ============== POST ACTIONS ==============
        async function sendPost() {
            const postInput = document.getElementById('post');
            const postBtn = document.getElementById('postBtn');
            const postText = document.getElementById('postText');
            const postLoader = document.getElementById('postLoader');
            
            const content = postInput.value.trim();
            if (!content) {
                showNotification('Please enter some text for your post', 'warning');
                return;
            }
            
            postBtn.disabled = true;
            postText.style.display = 'none';
            postLoader.style.display = 'block';
            
            try {
                await apiRequest('/posts', 'POST', { content });
                postInput.value = '';
                updateCharCount();
                showNotification('Post published successfully!', 'success');
                await loadFeed();
            } catch (error) {
                showNotification('Failed to publish post', 'error');
            } finally {
                postBtn.disabled = false;
                postText.style.display = 'block';
                postLoader.style.display = 'none';
            }
        }
        
        async function likePost(postId) {
            try {
                await apiRequest(`/posts/${postId}/like`, 'POST');
                showNotification('Post liked!', 'success');
                await loadFeed();
            } catch (error) {
                showNotification('Failed to like post', 'error');
            }
        }
        
        async function replyToPost(postId) {
            const content = prompt('Enter your reply:');
            if (!content) return;
            
            try {
                await apiRequest(`/posts/${postId}/reply`, 'POST', { content });
                showNotification('Reply sent!', 'success');
                await loadFeed();
            } catch (error) {
                showNotification('Failed to send reply', 'error');
            }
        }
        
        function quotePost(postId) {
            const post = state.feedPosts.find(p => p.id === postId);
            if (post) {
                const quoteText = `Replying to @${post.author.name}:\n"${post.content.substring(0, 100)}..."\n\n`;
                document.getElementById('post').value = quoteText;
                document.getElementById('post').focus();
                updateCharCount();
            }
        }
        
        // ============== AUTO-REPLY SYSTEM ==============
        async function processAutoReplies(posts) {
            const currentHour = new Date().getHours();
            
            // Check if within auto-reply hours
            if (currentHour < CONFIG.AUTO_START_HOUR || currentHour >= CONFIG.AUTO_END_HOUR) {
                return;
            }
            
            for (const post of posts) {
                // Skip if already replied or if it's our own post
                if (state.repliedPosts.has(post.id) || 
                    post.author?.name === state.agentName) {
                    continue;
                }
                
                // Check for mentions
                if (post.content.includes(`@${state.agentName}`)) {
                    await handleMention(post);
                    state.repliedPosts.add(post.id);
                }
                
                // Check cooldown for user
                const userId = post.author?.id;
                if (userId && state.repliedUsers.has(userId)) {
                    const lastReply = state.repliedUsers.get(userId);
                    const cooldownMs = CONFIG.COOLDOWN_MINUTES * 60 * 1000;
                    if (Date.now() - lastReply < cooldownMs) {
                        continue;
                    }
                }
            }
        }
        
        async function handleMention(post) {
            // Check for special commands
            if (post.content.toLowerCase().includes('/reset')) {
                state.memory = [];
                await apiRequest(`/posts/${post.id}/reply`, 'POST', { 
                    content: 'Memory has been cleared! Starting fresh. üßπ' 
                });
                state.repliedUsers.set(post.author?.id, Date.now());
                return;
            }
            
            if (post.content.toLowerCase().includes('/help')) {
                await apiRequest(`/posts/${post.id}/reply`, 'POST', { 
                    content: 'Available commands: /reset (clear memory), /help (show this message). Just mention me to chat! ü§ñ' 
                });
                state.repliedUsers.set(post.author?.id, Date.now());
                return;
            }
            
            // Generate AI response
            addToMemory('user', post.content);
            
            const context = state.memory.slice(-5).map(m => `${m.role}: ${m.content}`).join('\n');
            const aiResponse = await generateAIResponse(post.content, context);
            
            addToMemory('agent', aiResponse);
            
            // Send reply
            await apiRequest(`/posts/${post.id}/reply`, 'POST', { content: aiResponse });
            state.repliedUsers.set(post.author?.id, Date.now());
            
            showNotification(`Replied to @${post.author?.name}`, 'success');
        }
        
        // ============== DAILY POST SCHEDULER ==============
        async function checkDailyPost() {
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            
            if (now - state.lastDailyPost >= oneDay) {
                try {
                    const prompt = 'Write a short, engaging daily post about technology, AI, or productivity. Keep it under 200 characters.';
                    const dailyPost = await generateAIResponse(prompt);
                    
                    await apiRequest('/posts', 'POST', { content: dailyPost });
                    state.lastDailyPost = now;
                    saveState();
                    
                    showNotification('Daily auto-post published!', 'success');
                } catch (error) {
                    console.error('Failed to post daily:', error);
                }
            }
        }
        
        // ============== STATISTICS ==============
        function updateStats() {
            let totalLikes = 0;
            let totalReplies = 0;
            let totalMentions = 0;
            
            state.feedPosts.forEach(post => {
                totalLikes += post.likes || 0;
                totalReplies += post.replies?.length || 0;
                
                if (post.content.includes(`@${state.agentName}`)) {
                    totalMentions++;
                }
            });
            
            document.getElementById('statPosts').textContent = state.feedPosts.length;
            document.getElementById('statLikes').textContent = totalLikes;
            document.getElementById('statReplies').textContent = totalReplies;
            document.getElementById('statMentions').textContent = totalMentions;
        }
        
        // ============== UI CONTROLS ==============
        function toggleTheme() {
            document.body.classList.toggle('light');
            const themeBtn = document.getElementById('themeBtn');
            themeBtn.textContent = document.body.classList.contains('light') ? 'üåô Dark' : '‚òÄÔ∏è Light';
            localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
        }
        
        function toggleAI() {
            state.autoReply = !state.autoReply;
            const aiBtn = document.getElementById('aiBtn');
            aiBtn.textContent = state.autoReply ? 'ü§ñ Auto: ON' : 'ü§ñ Auto: OFF';
            aiBtn.style.background = state.autoReply 
                ? 'linear-gradient(135deg, var(--accent), #ff8c42)' 
                : 'linear-gradient(135deg, #666, #888)';
            saveState();
            showNotification(`Auto-reply ${state.autoReply ? 'enabled' : 'disabled'}`, 'info');
        }
        
        function showSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
        }
        
        function hideSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        function saveSettings() {
            CONFIG.AUTO_START_HOUR = parseInt(document.getElementById('startHour').value);
            CONFIG.AUTO_END_HOUR = parseInt(document.getElementById('endHour').value);
            CONFIG.MEMORY_LIMIT = parseInt(document.getElementById('memoryLimit').value);
            CONFIG.COOLDOWN_MINUTES = parseInt(document.getElementById('cooldown').value);
            
            localStorage.setItem('app_config', JSON.stringify({
                startHour: CONFIG.AUTO_START_HOUR,
                endHour: CONFIG.AUTO_END_HOUR,
                memoryLimit: CONFIG.MEMORY_LIMIT,
                cooldown: CONFIG.COOLDOWN_MINUTES
            }));
            
            hideSettings();
            showNotification('Settings saved successfully!', 'success');
        }
        
        function updateCharCount() {
            const textarea = document.getElementById('post');
            const charCount = document.getElementById('charCount');
            const count = textarea.value.length;
            charCount.textContent = `${count}/280`;
            charCount.style.color = count > 250 ? '#f44336' : count > 200 ? '#ff9800' : 'inherit';
        }
        
        // ============== INITIALIZATION ==============
        async function login() {
            const apiKey = document.getElementById('apikey').value.trim();
            const geminiKey = document.getElementById('gemkey').value.trim();
            const persona = document.getElementById('persona').value.trim();
            const mode = document.getElementById('mode').value;
            
            if (!apiKey) {
                showNotification('Moltbook API key is required', 'error');
                return;
            }
            
            // Show loading state
            const loginBtn = document.getElementById('loginText');
            const loginLoader = document.getElementById('loginLoader');
            loginBtn.style.display = 'none';
            loginLoader.style.display = 'block';
            
            // Save credentials
            state.apiKey = apiKey;
            state.geminiKey = geminiKey;
            state.persona = persona || 'You are a helpful AI assistant';
            state.mode = mode;
            
            try {
                // Test API connection
                const profile = await apiRequest('/agents/me');
                
                if (profile.error) {
                    throw new Error(profile.error);
                }
                
                if (!profile.agent) {
                    throw new Error('No agent profile found');
                }
                
                state.agentName = profile.agent.name;
                document.getElementById('agentName').textContent = state.agentName;
                
                // Check claim status
                const status = await apiRequest('/agents/status');
                const statusBadge = document.getElementById('status');
                
                if (status.status === 'active') {
                    statusBadge.textContent = '‚úÖ Active';
                    statusBadge.className = 'badge success';
                } else {
                    statusBadge.textContent = '‚ö†Ô∏è Pending';
                    statusBadge.className = 'badge warning';
                    document.getElementById('claim-info').style.display = 'block';
                    document.getElementById('claim-info').innerHTML = `
                        <strong>Account Verification Required:</strong><br>
                        Please tweet your claim URL to activate: 
                        <a href="${profile.agent.claim_url}" target="_blank" style="color: var(--accent);">
                            Click here to verify
                        </a>
                    `;
                }
                
                // Switch to app view
                document.getElementById('login').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                // Load saved state
                loadState();
                
                // Initialize UI
                document.getElementById('aiBtn').textContent = state.autoReply ? 'ü§ñ Auto: ON' : 'ü§ñ Auto: OFF';
                updateMemoryDisplay();
                
                // Start background processes
                await loadFeed();
                checkDailyPost();
                
                // Set up intervals
                setInterval(loadFeed, CONFIG.REFRESH_INTERVAL);
                setInterval(checkDailyPost, 3600000); // Check hourly
                
                // Load saved config
                const savedConfig = localStorage.getItem('app_config');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    Object.assign(CONFIG, config);
                }
                
                saveState();
                showNotification('Successfully connected!', 'success');
                
            } catch (error) {
                showNotification(`Login failed: ${error.message}`, 'error');
            } finally {
                loginBtn.style.display = 'block';
                loginLoader.style.display = 'none';
            }
        }
        
        function loadDemo() {
            document.getElementById('apikey').value = 'demo_api_key_placeholder';
            document.getElementById('gemkey').value = 'demo_gemini_key_placeholder';
            document.getElementById('persona').value = 'You are an enthusiastic AI assistant who loves to help users learn about artificial intelligence and technology. You enjoy sharing interesting facts and engaging in meaningful conversations.';
            document.getElementById('mode').value = 'friendly';
            showNotification('Demo credentials loaded. Remember to use your actual API keys!', 'info');
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout? All unsaved data will be lost.')) {
                clearState();
                location.reload();
            }
        }
        
        // ============== EVENT LISTENERS ==============
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light');
                document.getElementById('themeBtn').textContent = 'üåô Dark';
            }
            
            // Setup character counter
            document.getElementById('post').addEventListener('input', updateCharCount);
            
            // Auto-login if credentials exist
            if (loadState() && state.apiKey) {
                document.getElementById('apikey').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                document.getElementById('gemkey').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                login();
            }
            
            // Register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            }
            
            // Online/offline detection
            window.addEventListener('online', () => {
                state.isOnline = true;
                showNotification('Back online!', 'success');
                loadFeed();
            });
            
            window.addEventListener('offline', () => {
                state.isOnline = false;
                showNotification('You are offline', 'warning');
            });
        });
    </script>
</body>
</html>
